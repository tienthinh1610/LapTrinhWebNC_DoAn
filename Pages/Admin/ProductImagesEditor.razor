@using Microsoft.AspNetCore.Components.Forms
@using System.IO

@inject Microsoft.AspNetCore.Hosting.IWebHostEnvironment WebHostEnvironment

@* Component: ProductImagesEditor.razor *@
<div class="p-3 border rounded mt-3 bg-light">
    <h5 class="text-primary">Qu·∫£n l√Ω H√¨nh ·∫£nh S·∫£n ph·∫©m</h5>

    @* --- Hi·ªÉn th·ªã c√°c H√¨nh ·∫£nh hi·ªán c√≥ --- *@
    <div class="d-flex flex-wrap mb-3">
        @if (Product.Images?.Count > 0)
        {
            @foreach (var image in Product.Images)
            {
                <div class="card me-2 mb-2" style="width: 10rem;">
                    <img src="@image.ImageUrl" class="card-img-top p-2" alt="Product Image" style="height: 100px; object-fit: contain;">
                    <div class="card-body p-1 text-center">
                        <small class="text-muted">@image.DisplayOrder</small>
                        <button type="button" class="btn btn-sm btn-outline-danger w-100" @onclick="@(() => RemoveImage(image))">X√≥a</button>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-muted">S·∫£n ph·∫©m ch∆∞a c√≥ h√¨nh ·∫£nh n√†o.</p>
        }
    </div>

    @* --- Form ƒë·ªÉ Th√™m Image m·ªõi b·∫±ng c√°ch Ch·ªçn File --- *@
    <div class="d-flex align-items-end mt-3">
        <div class="form-group me-2 flex-grow-1">
            <label>Ch·ªçn File H√¨nh ·∫£nh</label>
            @* üåü S·ª¨ D·ª§NG INPUTFILE THAY V√å INPUTTEXT *@
            <InputFile OnChange="@HandleFileSelection" class="form-control" accept="image/*" />
        </div>
        <div class="form-group me-2" style="width: 100px;">
            <label>Th·ª© t·ª±</label>
            <InputNumber class="form-control" @bind-Value="newDisplayOrder" />
        </div>
        @if (isLoading)
        {
             <button type="button" class="btn btn-warning" disabled>ƒêang t·∫£i...‚è≥</button>
        }
    </div>
</div>

@code {
    [Parameter]
    public Product Product { get; set; } = new Product();

    private IBrowserFile? selectedFile;
    private int newDisplayOrder { get; set; } = 1;
    private bool isLoading = false;
    
    // Gi·ªõi h·∫°n k√≠ch th∆∞·ªõc file (v√≠ d·ª•: 5MB)
    private const long MaxFileSize = 1024 * 1024 * 5; 

    // Ph∆∞∆°ng th·ª©c l·∫Øng nghe s·ª± ki·ªán khi ng∆∞·ªùi d√πng ch·ªçn file
    private async Task HandleFileSelection(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;

        if (selectedFile != null)
        {
            isLoading = true;
            StateHasChanged(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i loading

            // 1. T·∫†O T√äN FILE DUY NH·∫§T V√Ä ƒê∆Ø·ªúNG D·∫™N L∆ØU TR·ªÆ
            var uniqueFileName = $"{Guid.NewGuid().ToString()}_{selectedFile.Name}";
            var uploadPath = Path.Combine(WebHostEnvironment.WebRootPath, "images", uniqueFileName);
            var relativeUrl = $"/images/{uniqueFileName}";
            
            try
            {
                // 2. L∆ØU FILE V√ÄO TH∆Ø M·ª§C wwwroot/images
                await using FileStream fs = new(uploadPath, FileMode.Create);
                await selectedFile.OpenReadStream(MaxFileSize).CopyToAsync(fs);

                // 3. TH√äM URL T∆Ø∆†NG ƒê·ªêI V√ÄO DANH S√ÅCH H√åNH ·∫¢NH C·ª¶A S·∫¢N PH·∫®M
                if (Product.Images == null) Product.Images = new List<ProductImage>();

                Product.Images.Add(new ProductImage
                {
                    ImageUrl = relativeUrl, // L∆∞u ƒë∆∞·ªùng d·∫´n t∆∞∆°ng ƒë·ªëi ƒë·ªÉ truy c·∫≠p web
                    DisplayOrder = newDisplayOrder,
                    IsMainImage = Product.Images.Count == 0 
                });

                // C·∫≠p nh·∫≠t th·ª© t·ª± hi·ªÉn th·ªã cho l·∫ßn ti·∫øp theo
                newDisplayOrder = Product.Images.Count > 0 ? Product.Images.Max(i => i.DisplayOrder) + 1 : 1;
            }
            catch (Exception ex)
            {
                Console.WriteLine($"L·ªói upload file: {ex.Message}");
                // Th√™m logic th√¥ng b√°o l·ªói cho ng∆∞·ªùi d√πng n·∫øu c·∫ßn
            }
            finally
            {
                selectedFile = null;
                isLoading = false;
            }
        }
    }

    // Ph∆∞∆°ng th·ª©c x√≥a Image
    private void RemoveImage(ProductImage image)
    {
        if (Product.Images != null)
        {
            Product.Images.Remove(image);
        }
    }
}